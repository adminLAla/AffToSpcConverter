<Window x:Class="AffToSpcConverter.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:views="clr-namespace:AffToSpcConverter.Views"
        Title="Arcaea → In Falsus 转换器" Height="1080" Width="1080">

    <DockPanel>

        <!-- ===== 菜单栏 ===== -->
        <Menu DockPanel.Dock="Top">
            <MenuItem Header="文件(_F)">
                <MenuItem Header="打开 .aff..." Click="BtnOpenAff_Click"/>
                <MenuItem Header="保存 .spc..." Click="BtnSaveSpc_Click"/>
                <Separator/>
                <MenuItem Header="退出(_X)" Click="MenuExit_Click"/>
            </MenuItem>
            <MenuItem Header="打包(_P)">
                <MenuItem Header="打包资源..." Click="MenuPackage_Click"/>
            </MenuItem>
            <MenuItem Header="选项(_O)">
                <MenuItem Header="推荐键位映射 (4轨→5轨)"
                          IsCheckable="True" IsChecked="{Binding RecommendedKeymap}"/>
                <MenuItem Header="禁用轨道 (0 &amp; 4)"
                          IsCheckable="True" IsChecked="{Binding DisableLanes}"/>
                <Separator/>
                <MenuItem Header="设置..." Click="MenuSettings_Click"/>
            </MenuItem>
            <MenuItem Header="工具(_T)">
                <MenuItem Header="生成报告..." Click="MenuReport_Click"/>
            </MenuItem>
            <!-- 可视化预览切换按钮移至菜单栏 -->
            <MenuItem Header="视图(_V)">
                <MenuItem x:Name="MenuVisualPreview" Header="▶  可视化预览"
                          IsCheckable="True"
                          Checked="OnPreviewToggled" Unchecked="OnPreviewToggled"/>
            </MenuItem>
            <MenuItem Header="帮助(_H)">
                <MenuItem Header="关于" Click="MenuAbout_Click"/>
            </MenuItem>
        </Menu>

        <!-- ===== 工具栏（文本编辑模式）- 仅在非预览状态显示 ===== -->
        <Border x:Name="ToolbarText" DockPanel.Dock="Top"
                BorderBrush="#CCCCCC" BorderThickness="0,0,0,1" Padding="6,4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- 文件与转换按钮 -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Width="100" Margin="0,0,4,0" Click="BtnOpenAff_Click">打开 .aff</Button>
                    <Button Width="100" Margin="0,0,4,0" Click="BtnOpenSpc_Click">打开 .spc</Button>
                    <Button Width="100" Margin="0,0,4,0" Click="BtnConvert_Click">转换</Button>
                    <Button Width="100" Margin="0,0,12,0" Click="BtnSaveSpc_Click">保存 .spc</Button>
                </StackPanel>

                <!-- 状态提示 -->
                <TextBlock Grid.Column="1" Text="{Binding Status}"
                           VerticalAlignment="Center" Margin="12,0" Foreground="#337733"/>
            </Grid>
        </Border>

        <!-- ===== 工具栏（预览模式）- 仅在预览状态显示 ===== -->
        <Border x:Name="ToolbarPreview" DockPanel.Dock="Top" Visibility="Collapsed"
                BorderBrush="#CCCCCC" BorderThickness="0,0,0,1" Padding="6,4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- 背景音乐与播放控件 -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Width="100" Margin="0,0,4,0" Click="BtnOpenBgm_Click">打开 BGM</Button>
                    <TextBlock Text="{Binding BgmFileName}" VerticalAlignment="Center"
                               Margin="0,0,8,0" Foreground="#555555" FontSize="12"/>
                    <Button Width="32" Margin="0,0,2,0" Click="BtnPlayPause_Click"
                            ToolTip="播放 / 暂停">
                        <TextBlock>
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="▶"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsPlaying}" Value="True">
                                            <Setter Property="Text" Value="⏸"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </Button>
                    <Button Width="32" Click="BtnRestart_Click" ToolTip="从头播放">↩</Button>
                </StackPanel>

                <!-- 状态提示 -->
                <TextBlock Grid.Column="1" Text="{Binding Status}"
                           VerticalAlignment="Center" Margin="12,0" Foreground="#337733"/>
            </Grid>
        </Border>

        <!-- ===== 主内容区 ===== -->
        <Grid x:Name="MainContentGrid">

            <!-- 层 0：文本面板（转换视图） -->
            <Grid x:Name="TextPanelsGrid">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" MinWidth="120"/>
                    <ColumnDefinition Width="4"/>
                    <ColumnDefinition Width="*" MinWidth="120"/>
                </Grid.ColumnDefinitions>

                <!-- 输入面板 -->
                <DockPanel Grid.Column="0">
                    <TextBlock DockPanel.Dock="Top" Text="输入 (.aff)"
                               FontSize="11" Foreground="#666666" Margin="4,2"/>
                    <TextBox Text="{Binding AffPreview}"
                             FontFamily="Consolas" FontSize="12"
                             VerticalScrollBarVisibility="Auto"
                             HorizontalScrollBarVisibility="Auto"
                             IsReadOnly="True" TextWrapping="NoWrap" Padding="4"/>
                </DockPanel>

                <GridSplitter Grid.Column="1" Width="4"
                              HorizontalAlignment="Stretch" Background="#DDDDDD"/>

                <!-- 输出面板 -->
                <DockPanel Grid.Column="2">
                    <TextBlock DockPanel.Dock="Top" Text="输出 (.spc)"
                               FontSize="11" Foreground="#666666" Margin="4,2"/>
                    <TextBox Text="{Binding SpcPreview}"
                             FontFamily="Consolas" FontSize="12"
                             VerticalScrollBarVisibility="Auto"
                             HorizontalScrollBarVisibility="Auto"
                             IsReadOnly="True" TextWrapping="NoWrap" Padding="4"/>
                </DockPanel>
            </Grid>

            <!-- 层 1：可视化预览覆盖层 -->
            <Grid x:Name="PreviewOverlay" Visibility="Collapsed">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- 预览工具栏 -->
                <Border Grid.Row="0" BorderBrush="#CCCCCC" BorderThickness="0,0,0,1" Padding="6,4">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Orientation="Horizontal">
                            <TextBlock Text="时间:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                            <Slider Width="220" Minimum="0"
                                    Maximum="{Binding PreviewMaxTimeMs}"
                                    Value="{Binding PreviewTimeMs, Mode=TwoWay}"
                                    VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding PreviewTimeMs, StringFormat={}{0}ms}"
                                       VerticalAlignment="Center" FontFamily="Consolas"
                                       MinWidth="64" Margin="4,0,12,0"/>

                            <TextBlock Text="缩放:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                            <Slider Width="140" Minimum="40" Maximum="1200"
                                    Value="{Binding PreviewPixelsPerSecond, Mode=TwoWay}"
                                    VerticalAlignment="Center"/>
                            <TextBlock VerticalAlignment="Center" FontFamily="Consolas"
                                       MinWidth="64" Margin="4,0,12,0">
                                <TextBlock.Text>
                                    <MultiBinding StringFormat="{}{0:0} px/s">
                                        <Binding Path="PreviewPixelsPerSecond"/>
                                    </MultiBinding>
                                </TextBlock.Text>
                            </TextBlock>

                            <TextBlock Text="速度:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                            <Slider Width="100" Minimum="0.25" Maximum="3.0"
                                    Value="{Binding PreviewSpeed, Mode=TwoWay}"
                                    VerticalAlignment="Center"/>
                            <TextBlock VerticalAlignment="Center" FontFamily="Consolas"
                                       MinWidth="44" Margin="4,0,12,0"
                                       Text="{Binding PreviewSpeed, StringFormat={}{0:0.00}x}"/>

                            <TextBlock Text="Ctrl+滚轮=缩放  左键拖=滚动  右键拖=缩放  左键点击=选择"
                                       VerticalAlignment="Center" Foreground="#888888" FontSize="10"/>
                        </StackPanel>

                        <!-- 视图模式切换按钮 -->
                        <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="8,0,0,0">
                            <Button x:Name="BtnMergedView" Content="合并视图" Padding="8,3"
                                    Margin="0,0,2,0" Click="OnMergedViewClick"
                                    FontSize="11"/>
                            <Button x:Name="BtnSplitView" Content="分离视图" Padding="8,3"
                                    Click="OnSplitViewClick"
                                    FontSize="11" Background="#3366AA" Foreground="White"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- 预览区 + 属性面板 -->
                <Grid Grid.Row="1">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition x:Name="PropPanelColumn" Width="0"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- 属性面板（左侧，选中音符时显示） -->
                    <Border x:Name="PropPanel" Grid.Column="0" Background="#FF1E1E2E"
                            BorderBrush="#555" BorderThickness="0,0,1,0"
                            Visibility="Collapsed">
                        <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="8,6">
                            <StackPanel x:Name="PropStack" Width="240">
                                <!-- 标题 -->
                                <TextBlock x:Name="PropHeader" Text="编辑音符"
                                           Foreground="#DDDDDD" FontSize="14" FontWeight="Bold"
                                           Margin="0,0,0,8"/>

                                <!-- 时间 (ms) -->
                                <TextBlock Text="时间 (ms)" Foreground="#AAAAAA" FontSize="11" Margin="0,4,0,2"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="28"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="28"/>
                                    </Grid.ColumnDefinitions>
                                    <Button Grid.Column="0" Content="−" Click="PropDecTime" FontSize="14" Padding="0"/>
                                    <TextBox x:Name="PropTime" Grid.Column="1" TextAlignment="Right"
                                             FontFamily="Consolas" FontSize="12" Margin="2,0"/>
                                    <Button Grid.Column="2" Content="+" Click="PropIncTime" FontSize="14" Padding="0"/>
                                </Grid>

                                <!-- 动态字段容器，由代码动态填充 -->
                                <StackPanel x:Name="PropFieldsPanel"/>

                                <!-- 应用 / 取消 -->
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,12,0,0">
                                    <Button Content="✔ 应用" Padding="12,4" Margin="0,0,4,0"
                                            Click="PropApply_Click" FontSize="11"/>
                                    <Button Content="✕ 取消" Padding="12,4"
                                            Click="PropCancel_Click" FontSize="11"/>
                                </StackPanel>
                            </StackPanel>
                        </ScrollViewer>
                    </Border>

                    <!-- 预览控件 -->
                    <views:SpcPreviewGLControl
                        x:Name="PreviewControl"
                        Grid.Column="1"
                        Events="{Binding PreviewEvents}"
                        JudgeTimeMs="{Binding PreviewTimeMs, Mode=TwoWay}"
                        PixelsPerSecond="{Binding PreviewPixelsPerSecond, Mode=TwoWay}"
                        Speed="{Binding PreviewSpeed}"
                        TargetFps="{Binding PreviewTargetFps}"
                        ShowFpsStats="{Binding ShowFpsStats}"/>
                </Grid>
            </Grid>

        </Grid>
    </DockPanel>
</Window>
