<Window x:Class="AffToSpcConverter.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:views="clr-namespace:AffToSpcConverter.Views"
        Title="Arcaea → In Falsus Converter" Height="720" Width="1200">

    <DockPanel>

        <!-- ===== Menu ===== -->
        <Menu DockPanel.Dock="Top">
            <MenuItem Header="_File">
                <MenuItem Header="Open .aff..." Click="BtnOpenAff_Click"/>
                <MenuItem Header="Save .spc..." Click="BtnSaveSpc_Click"/>
                <Separator/>
                <MenuItem Header="E_xit" Click="MenuExit_Click"/>
            </MenuItem>
            <MenuItem Header="_Package">
                <MenuItem Header="Package Assets..." Click="MenuPackage_Click"/>
            </MenuItem>
            <MenuItem Header="_Options">
                <MenuItem Header="Recommended keymap (lane4→lane5)"
                          IsCheckable="True" IsChecked="{Binding RecommendedKeymap}"/>
                <MenuItem Header="Disable lanes (0 &amp; 4)"
                          IsCheckable="True" IsChecked="{Binding DisableLanes}"/>
                <Separator/>
                <MenuItem Header="Settings..." Click="MenuSettings_Click"/>
            </MenuItem>
            <MenuItem Header="_Tools">
                <MenuItem Header="Generate report..." Click="MenuReport_Click"/>
            </MenuItem>
            <MenuItem Header="_Help">
                <MenuItem Header="About" Click="MenuAbout_Click"/>
            </MenuItem>
        </Menu>

        <!-- ===== Toolbar ===== -->
        <Border DockPanel.Dock="Top" BorderBrush="#CCCCCC" BorderThickness="0,0,0,1" Padding="6,4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Left: file + convert buttons -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Width="100" Margin="0,0,4,0" Click="BtnOpenAff_Click">Open .aff</Button>
                    <Button Width="100" Margin="0,0,4,0" Click="BtnOpenSpc_Click">Open .spc</Button>
                    <Button Width="100" Margin="0,0,4,0" Click="BtnConvert_Click">Convert</Button>
                    <Button Width="100" Margin="0,0,12,0" Click="BtnSaveSpc_Click">Save .spc</Button>

                    <!-- Audio -->
                    <Button Width="100" Margin="0,0,4,0" Click="BtnOpenBgm_Click">Open BGM</Button>
                    <TextBlock Text="{Binding BgmFileName}" VerticalAlignment="Center"
                               Margin="0,0,8,0" Foreground="#555555" FontSize="12"/>
                    <Button Width="32" Margin="0,0,2,0" Click="BtnPlayPause_Click"
                            ToolTip="Play / Pause">
                        <TextBlock>
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="▶"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsPlaying}" Value="True">
                                            <Setter Property="Text" Value="⏸"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </Button>
                    <Button Width="32" Click="BtnRestart_Click" ToolTip="Restart from beginning">↩</Button>
                </StackPanel>

                <!-- Center: status -->
                <TextBlock Grid.Column="1" Text="{Binding Status}"
                           VerticalAlignment="Center" Margin="12,0" Foreground="#337733"/>

                <!-- Right: preview toggle -->
                <ToggleButton Grid.Column="2" x:Name="BtnShowPreview"
                              Content="▶  Visual Preview" Padding="10,4"
                              Checked="OnPreviewToggled" Unchecked="OnPreviewToggled"/>
            </Grid>
        </Border>

        <!-- ===== Main content area ===== -->
        <Grid x:Name="MainContentGrid">

            <!-- Layer 0: Text panels -->
            <Grid x:Name="TextPanelsGrid">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" MinWidth="120"/>
                    <ColumnDefinition Width="4"/>
                    <ColumnDefinition Width="*" MinWidth="120"/>
                </Grid.ColumnDefinitions>

                <!-- Input -->
                <DockPanel Grid.Column="0">
                    <TextBlock DockPanel.Dock="Top" Text="INPUT (.aff)"
                               FontSize="11" Foreground="#666666" Margin="4,2"/>
                    <TextBox Text="{Binding AffPreview}"
                             FontFamily="Consolas" FontSize="12"
                             VerticalScrollBarVisibility="Auto"
                             HorizontalScrollBarVisibility="Auto"
                             IsReadOnly="True" TextWrapping="NoWrap" Padding="4"/>
                </DockPanel>

                <GridSplitter Grid.Column="1" Width="4"
                              HorizontalAlignment="Stretch" Background="#DDDDDD"/>

                <!-- Output -->
                <DockPanel Grid.Column="2">
                    <TextBlock DockPanel.Dock="Top" Text="OUTPUT (.spc)"
                               FontSize="11" Foreground="#666666" Margin="4,2"/>
                    <TextBox Text="{Binding SpcPreview}"
                             FontFamily="Consolas" FontSize="12"
                             VerticalScrollBarVisibility="Auto"
                             HorizontalScrollBarVisibility="Auto"
                             IsReadOnly="True" TextWrapping="NoWrap" Padding="4"/>
                </DockPanel>
            </Grid>

            <!-- Layer 1: Visual Preview overlay -->
            <Grid x:Name="PreviewOverlay" Visibility="Collapsed">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Preview toolbar -->
                <Border Grid.Row="0" BorderBrush="#CCCCCC" BorderThickness="0,0,0,1" Padding="6,4">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="Time:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <Slider Width="280" Minimum="0"
                                Maximum="{Binding PreviewMaxTimeMs}"
                                Value="{Binding PreviewTimeMs, Mode=TwoWay}"
                                VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding PreviewTimeMs, StringFormat={}{0}ms}"
                                   VerticalAlignment="Center" FontFamily="Consolas"
                                   MinWidth="72" Margin="4,0,16,0"/>

                        <TextBlock Text="Zoom:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <Slider Width="180" Minimum="40" Maximum="1200"
                                Value="{Binding PreviewPixelsPerSecond, Mode=TwoWay}"
                                VerticalAlignment="Center"/>
                        <TextBlock VerticalAlignment="Center" FontFamily="Consolas"
                                   MinWidth="72" Margin="4,0,16,0">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="{}{0:0} px/s">
                                    <Binding Path="PreviewPixelsPerSecond"/>
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>

                        <TextBlock Text="Speed:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <Slider Width="140" Minimum="0.25" Maximum="3.0"
                                Value="{Binding PreviewSpeed, Mode=TwoWay}"
                                VerticalAlignment="Center"/>
                        <TextBlock VerticalAlignment="Center" FontFamily="Consolas"
                                   MinWidth="52" Margin="4,0,16,0"
                                   Text="{Binding PreviewSpeed, StringFormat={}{0:0.00}x}"/>

                        <TextBlock Text="Ctrl+滚轮=缩放  左键拖=滚动  右键拖=缩放"
                                   VerticalAlignment="Center" Foreground="#888888" FontSize="11"/>
                    </StackPanel>
                </Border>

                <!-- Preview control -->
                <views:SpcPreviewSkiaControl
                    x:Name="PreviewControl"
                    Grid.Row="1"
                    Events="{Binding PreviewEvents}"
                    JudgeTimeMs="{Binding PreviewTimeMs, Mode=TwoWay}"
                    PixelsPerSecond="{Binding PreviewPixelsPerSecond, Mode=TwoWay}"
                    Speed="{Binding PreviewSpeed}"/>
            </Grid>

        </Grid>
    </DockPanel>
</Window>
